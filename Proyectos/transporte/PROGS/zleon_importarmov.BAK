PARAMETERS ldfecha
lcfecha = IIF(PCOUNT()< 1,"01-01-2009",DTOC(ldfecha))

CLOSE DATABASES
CLOSE TABLES
OPEN DATABASE ? EXCLUSIVE

SET SAFETY OFF

SET CPCOMPILE TO 1252
codepage = 1252
SET CPDIALOG ON

SET DATABASE TO LEON

USE leon!ctacte IN 0 ALIAS Csrctacte EXCLUSIVE

USE leon!maopera IN 0 ALIAS CsrMaopera EXCLUSIVE
*ZAP IN CsrMaopera

USE leon!movctacte IN 0 ALIAS CsrMovctacte EXCLUSIVE
*ZAP IN CsrMovctacte



*USE datos!tablaasi IN 0 ALIAS CsrTablaasi EXCLUSIVE
*ZAP IN CsrTablaasi

SET SAFETY ON

USE  "\soft\leon\gestion\clientes" in 0 alias CsrDeudor EXCLUSIVE

USE  "\soft\leon\gestion\proveed" in 0 alias CsrAcreedor EXCLUSIVE

USE "\soft\leon\gestion\movimien" IN 0 ALIAS CsrMovipub EXCLUSIVE

USE  "\soft\leon\gestion\moviprov" in 0 alias CsrMoviprov EXCLUSIVE

USE  "\soft\leon\gestion\comproba" in 0 alias CsrComproba EXCLUSIVE





*fecha de importacion
ldfecha=CTOD(lcfecha)
lcfiscal=ALLTRIM(STR(YEAR(ldfecha)))+ALLTRIM(STR(MONTH(ldfecha)))+ALLTRIM(STR(DAY(ldfecha)))
lnidmaopera=1
SELECT CsrMaopera
IF RECCOUNT('CsrMaopera')>0
	GO bottom
	lnidmaopera=VAL(SUBSTR(ALLTRIM(STR(Csrmaopera.id)),3))
	
ENDIF
lnidmaoperas =  VAL(STR(Goapp.sucursal10 + 10,2)+LTRIM(STR(lnidmaopera)))
lnidmovctacte=1
SELECT CsrMovCtacte
IF RECCOUNT('CsrMovctacte')>0
	GO bottom
	lnidmovctacte=VAL(SUBSTR(ALLTRIM(STR(Csrmovctacte.id)),3))
ENDIF
lnidmovctactes =  VAL(STR(Goapp.sucursal10 + 10,2)+LTRIM(STR(lnidmovctacte)))

ldfechasis=DATETIME(YEAR(ldfecha),MONTH(ldfecha),DAY(ldfecha),0,0,0)
ldfechas=DATETIME(YEAR(DATE()),MONTH(DATE()),DAY(DATE()),0,0,0)
		
		
**** sumatoria de los movimientos anteriores
SELECT distinct cliente,IIF(ISNULL(CsrDeudor.saldo_ant),0,CsrDeudor.saldo_ant) as saldo_ant;
,SUM(importeco) as pago;
FROM Csrmovipub ;
LEFT JOIN CsrComproba ON CsrMovipub.tipocomp=CsrComproba.numero;
left JOIN csrDeudor ON csrMovipub.cliente = CsrDeudor.numero;
where fecha<ldfecha AND estado<>'A' AND CsrComproba.debcre='C';
GROUP BY cliente,CsrDeudor.saldo_ant INTO CURSOR CsrAPago READWRITE 

 

replace ALL pago WITH IIF(saldo_ant<0,(saldo_ant*-1)+pago,pago-saldo_ant) IN CsrAPago

SELECT distinct cliente,SUM(importeco) as importe;
FROM Csrmovipub;
LEFT JOIN CsrComproba ON CsrMovipub.tipocomp=CsrComproba.numero;
where fecha<ldfecha AND estado<>'A' AND  CsrComproba.debcre='D';
GROUP BY cliente INTO CURSOR CsrAImporte READWRITE 

*replace ALL importe WITH IIF(saldo_ant>=0,(saldo_ant)+importe,importe) IN CsrAImporte

SELECT distinct cliente FROM Csrmovipub ORDER BY cliente INTO CURSOR CsrClientes

SELECT Csrclientes.cliente, IIF(ISNULL(CsrAImporte.importe),000000000000000.000,CsrAimporte.importe) as importe;
, IIF(ISNULL(CsrAPAgo.pago),000000000000000.000,CsrAPago.pago) as pago;
,000000000000000000000.000 as saldo;
FROM CsrClientes;
LEFT JOIN  CsrAImporte ON Csrclientes.cliente=CsrAImporte.cliente;
LEFT JOIN  CsrAPago ON Csrclientes.cliente=CsrAPago.cliente;
into CURSOR CsrAnterior READWRITE

replace ALL saldo WITH importe-pago IN CsrAnterior
DELETE FROM CsrAnterior WHERE saldo=0
****sumatoria de los movimientos posteriores

SELECT distinct cliente,SUM(importeco) as pago;
FROM Csrmovipub ;
LEFT JOIN CsrComproba ON CsrMovipub.tipocomp=CsrComproba.numero;
where fecha>=ldfecha AND estado<>'A' AND CsrComproba.debcre='C';
GROUP BY cliente INTO CURSOR CsrPPago READWRITE 

SELECT distinct cliente,SUM(importeco) as importe;
FROM Csrmovipub;
LEFT JOIN CsrComproba ON CsrMovipub.tipocomp=CsrComproba.numero;
where fecha>=ldfecha AND estado<>'A' AND  CsrComproba.debcre='D';
GROUP BY cliente INTO CURSOR CsrPImporte READWRITE 

SELECT distinct cliente FROM Csrmovipub ORDER BY cliente INTO CURSOR CsrClientes

SELECT Csrclientes.cliente;
, IIF(ISNULL(CsrPImporte.importe),0000000000.0000,CsrPimporte.importe) as importe;
, IIF(ISNULL(CsrPPAgo.pago),00000000000.000,CsrPPago.pago) as pago;
,0000000000000000.000 as saldo;
FROM CsrClientes;
LEFT JOIN  CsrPImporte ON Csrclientes.cliente=CsrPImporte.cliente;
LEFT JOIN  CsrPPago ON Csrclientes.cliente=CsrPPago.cliente;
into CURSOR CsrSaldosPost READWRITE

replace ALL saldo WITH importe-pago IN CsrSaldosPost
DELETE FROM CsrSaldosPost WHERE saldo=0


replace ALL saldo WITH 0 IN CsrCtacte

SELECT CsrAnterior
*Oavisar.proceso('S','Procesando '+alias()) 
GO top

SCAN FOR !EOF('CsrAnterior')
	SELECT CsrCtacte
	LOCATE FOR ALLTRIM(cnumero)==ALLTRIM(STR(CsrAnterior.cliente))
	IF  ALLTRIM(cnumero)=ALLTRIM(STR(CsrAnterior.cliente))
		lnsigno=1
		replace Csrctacte.saldoant WITH 0, Csrctacte.saldo WITH CsrAnterior.Saldo IN CsrCtacte
		
		ldfechas=ldfechasis
		lnidcomproba=112
		lnimporte=CsrCtacte.saldo
		lcclasecomp="B"
		IF lnimporte<0
			lnimporte=lnimporte*-1
			lnsigno=-1
			lnidcomproba=113
			lcclasecomp="C"
		eNDIF
		lcletra=IIF(CsrCtacte.tipoiva=111,"A","B")
		lcnum=strtran(str(VAL(CsrCtacte.cnumero),8,0),' ','0')
		lcnumero=lcletra+"0000"+lcnum

		INSERT INTO CsrMaopera (id,origen,programa,sucursal,terminal,sector;
		,fechasis,idoperador,idvendedor,iddetanrocaja,idcomproba,numcomp;
		,clasecomp,turno,puestocaja,idcotizadolar,switch,estado,detalle,fechaserver);
		VALUES (lnidmaoperas,"MOV","IMPORTACION MOVIMIENTOS",1,9,1,ldfechasis,111,111,100021,lnidcomproba,lcnumero;
		,lcclasecomp,1,1,1,"0000","0","Importación",ldfechasis)
		
		
		INSERT INTO CsrMovctacte (id,idmaopera,fecha,ctacte,idctacte,subnumero;
		,idsubcta,cuota,importe,saldo,entrega,vencimien,total,detalle,pefiscal;
		,switch,signo) VALUES (lnidmovctactes,lnidmaoperas,ldfechas,Csrctacte.cnumero;
		,CsrCtacte.id," ",0,1,lnimporte,lnimporte,0,ldfechasis,lnimporte;
		,"Saldo de Importación",SUBSTR(lcfiscal,1,6),"0000",lnsigno)
		
		lnidmovctacte=lnidmovctacte+1
		lnidmovctactes = VAL(STR(Goapp.sucursal10 + 10,2)+LTRIM(STR(lnidmovctacte)))
		lnidmaopera=lnidmaopera+1
		lnidmaoperas =  VAL(STR(Goapp.sucursal10 + 10,2)+LTRIM(STR(lnidmaopera)))
	ENDIF
ENDSCAN 
		
SELECT cliente,detalle,IIF((CsrComproba.debcre='C'),CsrMovipub.Importeco*-1,CsrMovipub.Importeco) as importe,fecha FROM CsrMovipub ;
LEFT JOIN CsrComproba ON CsrMovipub.tipocomp=CsrComproba.numero WHERE fecha>ldfecha AND estado<>'A';
order by cliente into cursor CsrPosterior

 
SELECT CsrSaldosPost
SCAN 
	SELECT CsrCtacte
	LOCATE FOR  VAL(cnumero)=CsrSaldosPost.cliente
	IF FOUND()
		replace Csrctacte.saldo WITH CsrCtacte.saldo+CsrSaldosPost.saldo IN CsrCtacte
	ENDIF 
ENDSCAN 

SELECT CsrPosterior
Oavisar.proceso('S','Procesando '+alias()) 
SCAN  
	SELECT CsrCtacte
	LOCATE FOR VAL(cnumero)=CsrPosterior.cliente
	IF FOUND()
		ldfechas=DATETIME(YEAR(CsrPosterior.fecha),month(CsrPosterior.fecha),day(CsrPosterior.fecha),0,0,0)
		lnsigno=1
		lnidcomproba=112
		lnimporte=CsrPosterior.importe
		lcclasecomp="B"
			IF lnimporte<0
				lnimporte=CsrPosterior.importe*-1
				lnsigno=-1
				lnidcomproba=113
				lcclasecomp="C"
			eNDIF
			lcletra=IIF(CsrCtacte.tipoiva=111,"A","B")
			lcnum=strtran(str(VAL(CsrCtacte.cnumero),8,0),' ','0')
			lcnumero=lcletra+"0000"+lcnum

			INSERT INTO CsrMaopera (id,origen,programa,sucursal,terminal,sector;
			,fechasis,idoperador,idvendedor,iddetanrocaja,idcomproba,numcomp;
			,clasecomp,turno,puestocaja,idcotizadolar,switch,estado,detalle,fechaserver);
			VALUES (lnidmaoperas,"MOV","IMPORTACION MOVIMIENTOS",1,9,1,ldfechasis,111,111,100021,lnidcomproba,lcnumero;
			,lcclasecomp,1,1,1,"0000","0","Importación",ldfechasis)
			
			
			INSERT INTO CsrMovctacte (id,idmaopera,fecha,ctacte,idctacte,subnumero;
			,idsubcta,cuota,importe,saldo,entrega,vencimien,total,detalle,pefiscal;
			,switch,signo) VALUES (lnidmovctactes,lnidmaoperas,ldfechas,Csrctacte.cnumero;
			,CsrCtacte.id," ",0,1,lnimporte,lnimporte,0,ldfechasis,lnimporte;
			,CsrPosterior.detalle,SUBSTR(lcfiscal,1,6),"0000",lnsigno)
			
			lnidmovctacte=lnidmovctacte+1
			lnidmovctactes = VAL(STR(Goapp.sucursal10 + 10,2)+LTRIM(STR(lnidmovctacte)))
			lnidmaopera=lnidmaopera+1
			lnidmaoperas =  VAL(STR(Goapp.sucursal10 + 10,2)+LTRIM(STR(lnidmaopera)))
	ENDIF
	SELECT CsrPosterior
ENDSCAN 

*Oavisar.proceso('S','Procesando saldos') 

*!*	SELECT cliente,SUM(importeco) as totalcomp,SUM(decontado) as decontado;
*!*	,00000000.000 as saldo FROM Csrmoviprov;
*!*	into CURSOR 'CsrDebito' readwrite;
*!*	GROUP BY cliente WHERE tipocomp=1 OR tipocomp=2

*!*	SELECT cliente,SUM(importeco) as importeco;
*!*	,00000000.000 as saldo FROM Csrmoviprov;
*!*	into CURSOR 'CsrCredito' readwrite;
*!*	GROUP BY cliente WHERE tipocomp=3 OR tipocomp=4

*!*	replace ALL cliente WITH 10000+cliente,saldo WITH totalcomp-decontado IN csrDebito
*!*	replace ALL cliente WITH 10000+cliente,saldo WITH importeco*-1 IN CsrCredito

*!*	SELECT CsrAcreedor.numero+10000 as cliente;
*!*	,(IIF(ISNULL(CsrDebito.saldo),0,CsrDebito.saldo)+IIF(ISNULL(CsrCredito.saldo),0,CsrCredito.saldo)-IIF(ISNULL(CsrAcreedor.saldo_ant),0,CsrAcreedor.saldo_ant)) as saldo ;
*!*	FROM CsrAcreedor;
*!*	left JOIN CsrDebito ON CsrAcreedor.numero+10000=CsrDebito.cliente;
*!*	left JOIN CsrCredito ON CsrDebito.cliente=csrcredito.cliente;
*!*	INTO CURSOR CsrSaldo READWRITE 

*!*	SELECT csrsaldo
*!*	Oavisar.proceso('S','Procesando '+alias()) 
*!*	GO top


*!*	SCAN FOR !EOF('CsrSaldo')
*!*		SELECT CsrCtacte
*!*		LOCATE FOR cnumero=ALLTRIM(STR(Csrsaldo.cliente))
*!*		IF FOUND()

*!*			replace saldo WITH CsrSaldo.saldo IN CsrCtacte
*!*		ENDIF
*!*		SELECT CsrSaldo
*!*	ENDSCAN

*!*	SELECT cliente+10000 as cliente,tipocomp,fecha_fac,vencimien,importeco,IIF(EMPTY(decontado),0,decontado)as decontado;
*!*	,letra,talonario,numcomp FROM CsrMoviprov ORDER BY cliente;
*!*	into cursor 'CsrAux' readwrite

*!*	SELECT CsrAcreedor
*!*	Oavisar.proceso('S','Procesando '+alias()) 
*!*	GO top

*!*	SCAN FOR !EOF('CsrAcreedor')
*!*		IF CsrAcreedor.saldo_ant<>0
*!*			ldfecha=DATETIME(1996,1,1,0,0,0)
*!*			lnsaldo=CsrAcreedor.saldo_ant*-1
*!*			INSERT INTO CsrAux(cliente,tipocomp,fecha_fac,vencimien,importeco,decontado);
*!*			VALUES (CsrAcreedor.numero+10000,2,ldfecha,ldfecha,lnsaldo,0)
*!*		ENDIF
*!*			
*!*	ENDSCAN
*!*	SELECT CsrAux
*!*	GO TOP 

*!*	SCAN FOR !EOF('CsrAux')
*!*			SELECT CsrCtacte
*!*			LOCATE FOR cnumero=ALLTRIM(STR(CsrAux.cliente))
*!*			IF FOUND()
*!*				DO CASE 
*!*					CASE CsrAux.tipocomp=1
*!*						lnidcompro=22
*!*						lcclase="A"
*!*					CASE CsrAux.tipocomp=2
*!*						lnidcompro=22
*!*						lcclase="A"
*!*					CASE CsrAux.tipocomp=3
*!*						lnidcompro=7
*!*						lcclase="C"
*!*					CASE CsrAux.tipocomp=4
*!*						lnidcompro=8
*!*						lcclase="D"
*!*				ENDCASE
*!*					lctalo=''
*!*					tam=LEN(ALLTRIM(STR(CsrAux.talonario)))
*!*					lctalo=strtran(str(CsrAux.talonario,4,0),' ','0')
*!*					lcnum=''
*!*					tam=LEN(ALLTRIM(STR(CsrAux.numcomp)))
*!*					lcnum=strtran(str(CsrAux.numcomp,8,0),' ','0')
*!*					lcnumero=ALLTRIM(CsrAux.letra)+ALLTRIM(lctalo)+ALLTRIM(lcnum)
*!*				
*!*					INSERT INTO CsrMaopera (id,origen,programa,sucursal,terminal,sector;
*!*					,fechasis,idoperador,idvendedor,iddetanrocaja,idcomproba,numcomp;
*!*					,clasecomp,turno,puestocaja,idcotizadolar,switch,estado,detalle,fechaserver);
*!*					VALUES (lnidmaopera,"IMP","IMPORTACION",1,9,1,ldfechasis,1,1,100021,lnidcompro;
*!*					,lcnumero,lcclase,1,1,1,"0000","0","Importación",ldfechasis)
*!*					
*!*					ldfechafac=DATETIME(YEAR(CsrAux.fecha_fac),MONTH(CsrAux.fecha_fac),DAY(CsrAux.fecha_fac),0,0,0)
*!*					lcperiodo=alltrim(STR(YEAR(CsrAux.fecha_fac)))+ALLTRIM(STR(MONTH(CsrAux.fecha_fac)))
*!*					ldfechavto=DATETIME(YEAR(CsrAux.vencimien),MONTH(CsrAux.vencimien),DAY(CsrAux.vencimien),0,0,0)
*!*					lnentrega=CsrAux.decontado
*!*					lnimporte=CsrAux.Importeco
*!*					lnsaldo=lnimporte-lnentrega
*!*					lnsigno=1
*!*					IF lnidcompro=2
*!*						IF lnimporte<0
*!*							lnimporte=lnimporte*-1
*!*						ENDIF 
*!*						lnsigno=-1
*!*					ELSE
*!*						IF lnidcompro=7 .or. lnidcompro=8
*!*							lnsigno=-1
*!*						ENDIF 
*!*					ENDIF
*!*								
*!*					INSERT INTO CsrMovctacte (id,idmaopera,fecha,ctacte,idctacte,subnumero;
*!*					,idsubcta,cuota,importe,saldo,entrega,vencimien,total,detalle,pefiscal;
*!*					,switch,signo) VALUES (lnidmovctacte,lnidmaopera,ldfechafac,Csrctacte.cnumero;
*!*					,CsrCtacte.id," ",0,1,lnimporte,lnimporte,0,ldfechavto,lnimporte;
*!*					,"Saldo de Importación",lcperiodo,"0000",-1*lnsigno)
*!*					
*!*					IF  lnentrega<>0
*!*						lnidmovctacte=lnidmovctacte+1
*!*						INSERT INTO CsrMovctacte (id,idmaopera,fecha,ctacte,idctacte,subnumero;
*!*						,idsubcta,cuota,importe,saldo,entrega,vencimien,total,detalle,pefiscal;
*!*						,switch,signo) VALUES (lnidmovctacte,lnidmaopera,ldfechafac,Csrctacte.cnumero;
*!*						,CsrCtacte.id," ",0,1,lnentrega,lnentrega,0,ldfechavto,lnimporte;
*!*						,"Saldo de Importación",lcperiodo,"0000",lnsigno)
*!*					ENDIF 
*!*						
*!*					
*!*					lnidmovctacte=lnidmovctacte+1
*!*					lnidmaopera=lnidmaopera+1
*!*			ENDIF
*!*			
*!*			SELECT CsrAux
*!*			
*!*	ENDSCAN

Oavisar.proceso('N') 
=MESSAGEBOX('Proceso terminado! ')
CLOSE tables
CLOSE INDEXES
CLOSE DATABASES
