SELECT csrproducto.id,csrproducto.numero as numero,csrproducto.nombre as nombre,ISNULL(csrdeposito.numero,0) as deposito
,csrproducto.unibulto,ISNULL(csrsubproducto.subnumero,0) as subnumero,ISNULL(CsrSubproducto.id,CAST(0 as int)) as idsubarti
,ISNULL(CsrDeposito.id,CAST(0 as int)) as iddeposito
,ISNULL(csrvariedad.nombre,SPACE(30)) as nomsubprod,Csrproducto.vtakilos as pesable
,ISNULL(Csrexistenc.existe,0) as existe,ISNULL(Csrexistenc.existedisp,0) as existedisp
,(select ISNULL(SUM(csrMovstock.cantidad*CsrMovstock.signo),0) from movstock as csrmovstock
	where csrproducto.id=csrmovstock.idarticulo and ISNULL(csrsubproducto.id,0)=csrmovstock.idsubarti
	and csrdeposito.id=csrmovstock.iddeposito ) sumacantidad
FROM producto as csrproducto
left join subproducto as Csrsubproducto ON Csrproducto.id=ISNULL(csrsubproducto.idarticulo,0)
left join variedad as Csrvariedad on Csrsubproducto.idvariedad = Csrvariedad.id
left join movstock as csrmovstock on Csrproducto.id = Csrmovstock.idarticulo and (csrsubproducto.id=ISNULL(csrmovstock.idsubarti,0) or csrmovstock.idsubarti=0)
left join deposito as csrdeposito on csrmovstock.iddeposito=csrdeposito.id
left join existenc as Csrexistenc on Csrproducto.id = Csrexistenc.idarticulo and (csrsubproducto.id=csrexistenc.idsubarti or (csrexistenc.idsubarti=0 and ISNULL(csrsubproducto.id,0)=0))and csrdeposito.id=csrexistenc.iddeposito
WHERE Csrproducto.id>0 and ISNULL(Csrdeposito.id,0) >=0 
GROUP BY csrproducto.numero,csrproducto.nombre,csrsubproducto.subnumero,csrvariedad.nombre,Csrexistenc.existe,csrproducto.id,csrsubproducto.id,csrproducto.unibulto
,csrdeposito.numero,csrdeposito.id,CsrExistenc.existedisp,CsrExistenc.kilos,CsrExistenc.kilosdisp,CsrProducto.vtakilos
ORDER BY numero,subnumero,deposito